#!/usr/bin/env bash
#: exec_target = cli
## Reset the database and clean up the files generated by the tests.
##
## Usage: fin reset_for_tests

## Delete all physical files with the name (l)ink*.txt generated by the tests
echo "SELECT fid FROM file_managed WHERE filename LIKE '%ink%.txt';" | drush --yes -l default sql:cli | xargs -I '{}' drush --yes -l default entity:delete file '{}' ;

## Delete all physical files with the name (m)emberslist*.csv generated by the tests
echo "SELECT fid FROM file_managed WHERE filename LIKE '%emberslist%.csv';" | drush --yes -l default sql:cli | xargs -I '{}' drush --yes -l default entity:delete file '{}' ;

# Reload the database.
drush --yes -l default sql:drop;
drush --yes -l default sql:cli < backups/db-dump-production-sanitised.sql;

# Update the database to the latest version.
drush --yes -l default pm:uninstall dblog;
drush --yes -l default pm:uninstall default_content;
drush --yes -l default cache:rebuild;
drush --yes -l default config:import;
drush --yes -l default cache:rebuild;
drush --yes -l default updatedb --no-cache-clear;
drush --yes -l default deploy:hook;

# Clear the recent log messages so that it only contains those from the tests.
drush --yes -l default wd-del all;

# Clear the flood table so that it can not stop the logins.
drush --yes -l default flood_unblock:all;

# Rebuild the search index.
drush --yes -l default search-api:clear;
drush --yes -l default search-api:rebuild-tracker;
drush --yes -l default search-api:index;

