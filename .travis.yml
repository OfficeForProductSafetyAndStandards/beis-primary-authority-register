########################
### BUILD
########################

language: php
php:
  - 7.1
services:
  - docker
install:
  - composer install
  - sudo sed -e "s?PAR_HASH_SALT?$PAR_HASH_SALT?g" --in-place web/sites/default/settings.php
  - cd docker
  - docker-compose up -d --force-recreate --build
  - cp ../web/sites/example.settings.local.php ../web/sites/default/settings.local.php
  - cat ../web/sites/settings.local.php.docker.append >> ../web/sites/default/settings.local.php
  - cd ..
  - docker exec -it par_beta_web bash -c "/usr/local/n/versions/node/7.2.1/bin/npm install"
  - docker exec -it par_beta_web bash -c "npm run gulp"
  - docker exec -it par_beta_web bash -c "cd /var/www/html/tests && /usr/local/n/versions/node/7.2.1/bin/npm install"
  - sleep 5 # Time for the server to boot
  - docker exec -i par_beta_web /var/www/html/vendor/bin/drush sql-cli @dev --root=/var/www/html/web < docker/fresh_drupal_postgres.sql
  - docker exec -i par_beta_web sh /var/www/html/drupal-update.sh /var/www/html
  - 'echo "#${TRAVIS_BUILD_NUMBER}: $(date -u)" > web/build_version.txt'

########################
### TEST
########################
before_script:
 - "gem install travis-artifacts"

script:
- travis_retry docker exec -i par_beta_web -c '/var/www/html/vendor/phpunit/phpunit/phpunit; (exit $?)'
- travis_retry docker exec -ti par_beta_web bash -c "cd tests && ./node_modules/.bin/wdio wdio.BUILD.conf.js"

after_script:
  - "travis-artifacts upload"

########################
### DEPLOY
########################

deploy:
  provider: cloudfoundry
  api: https://api.cloud.service.gov.uk
  username: nao.yoshino@transformuk.com
  password:
    secure: fh6ePSKsJUnXEeZVwUU4gwGxIwLAfaug6O+4Zs0Wmus5dYXuRgVXQ3RLP1rSyp4Hc6/Nt4CPt3A8ygFW5WGNRKNXXR3F47wXLGnixOKCDmLCz6VytUXesEXlqDkzXSBT7WZGqOTKdTLKJOhaV4Z9Oum/CL5QckKbHlBHinhL3IpH4zi+4tBERc1C6R6oRC9ZPiEsFr9FYOE0hqvFA8Vw0SkB5C3uyQaFh0WotNLkhdd4fUUotxzjA5Cr2KAUTaUcRw0Ceq90UPlWnwBJDxjaNokuEcO6S13HDXTTi/RXNZi4oRhePokbs6z01GssOSiVencbRHX+RT7a4jHwF0hZI9OMgXelnmYb4Jdq5FeVPBD9OenIXGCAo2nyxJ/EU+7InUlQAN6HDh5QO7B10aSJpaWfNt2X65+FeOP89rbLPyfisqxFtbGZW1/ur9VlXOt0c8h9f6vdled8pocT6sMO6duKhMM5xFhRyDBVv01ZCZxTXOGTgOPRUN9EsVsrxX2X8mtRMmr0hJ+vml4eb1I/3AEJX10SDi4e/S8i8mJ4oAaVK4kAR7oLnKT+feBbKqHha/xkU87kp49jm3k65FzkwJzGUNe5GStjEvXXWvK8EaSX2t42iFU4SgbsMi/BIsAyy2NMyB8ua9SziYG7JGwv5z+brl7QJrvniYzkom3JSso=
  organization: beis-nmo-trial
  space: sandbox
  on:
    repo: TransformCore/beis-par-beta

addons:
  artifacts:
    debug: true
    paths:
      - ./tests/reports
    target_paths: tests/$TRAVIS_BUILD_NUMBER
    bucket: transform-par-beta-artifacts
    s3_region: eu-west-1