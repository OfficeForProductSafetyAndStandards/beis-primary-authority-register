########################
### BUILD
########################

language: php
php:
- '5.6'
addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - oracle-java8-installer
      - g++-6
before_script:
  - sudo apt-get update
  - sudo apt-get install apache2 libapache2-mod-fastcgi
### enable php-fpm
  - sudo cp ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf.default ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf
  - sudo a2enmod rewrite actions fastcgi alias
  - echo "cgi.fix_pathinfo = 1" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
  - ~/.phpenv/versions/$(phpenv version-name)/sbin/php-fpm
### configure apache virtual hosts
  - sudo cp -f build/travis-ci-apache /etc/apache2/sites-available/default
  - sudo sed -e "s?%TRAVIS_BUILD_DIR%?$(pwd)?g" --in-place /etc/apache2/sites-available/default
  - sudo service apache2 restart
### install test dependencies
  - gcc --version
  - nvm install 7.2.1
  - git clone https://github.com/tj/n
  - cd n
  - sudo make install
  - sudo n 7.2.1
  - cd ../tests
  - /usr/local/n/versions/node/7.2.1/bin/npm install
  - cd ..
  - rm -rf n
before_install:
- psql -c 'create database par;' -U postgres
env:
  global:
    SIMPLETEST_BASE_URL: http://127.0.0.1:9000
    SIMPLETEST_DB: pgsql://postgres@127.0.0.1/par
    VCAP_SERVICES: '{''postgres'': [{''credentials'': {''database'': ''par'', ''username'':
      ''par'', ''password'': '''', ''host'': ''localhost'', ''post'': ''5432'', ''driver'':
      ''pgsql'', ''namespace'' => ''Drupal\Core\Database\Driver\pgsql'' } }]}'
install:
- sudo sed -e "s?PAR_HASH_SALT?$PAR_HASH_SALT?g" --in-place web/sites/default/settings.php
- composer install

########################
### TEST
########################

script: cd tests && ./node_modules/.bin/wdio ./wdio.BUILD.conf.js && cd .. && ./vendor/bin/phpunit --testsuite=par --printer="\Drupal\Tests\Listeners\HtmlOutputPrinter"

########################
### DEPLOY
########################

deploy:
  provider: cloudfoundry
  api: https://api.cloud.service.gov.uk
  username: nao.yoshino@transformuk.com
  password:
    secure: fh6ePSKsJUnXEeZVwUU4gwGxIwLAfaug6O+4Zs0Wmus5dYXuRgVXQ3RLP1rSyp4Hc6/Nt4CPt3A8ygFW5WGNRKNXXR3F47wXLGnixOKCDmLCz6VytUXesEXlqDkzXSBT7WZGqOTKdTLKJOhaV4Z9Oum/CL5QckKbHlBHinhL3IpH4zi+4tBERc1C6R6oRC9ZPiEsFr9FYOE0hqvFA8Vw0SkB5C3uyQaFh0WotNLkhdd4fUUotxzjA5Cr2KAUTaUcRw0Ceq90UPlWnwBJDxjaNokuEcO6S13HDXTTi/RXNZi4oRhePokbs6z01GssOSiVencbRHX+RT7a4jHwF0hZI9OMgXelnmYb4Jdq5FeVPBD9OenIXGCAo2nyxJ/EU+7InUlQAN6HDh5QO7B10aSJpaWfNt2X65+FeOP89rbLPyfisqxFtbGZW1/ur9VlXOt0c8h9f6vdled8pocT6sMO6duKhMM5xFhRyDBVv01ZCZxTXOGTgOPRUN9EsVsrxX2X8mtRMmr0hJ+vml4eb1I/3AEJX10SDi4e/S8i8mJ4oAaVK4kAR7oLnKT+feBbKqHha/xkU87kp49jm3k65FzkwJzGUNe5GStjEvXXWvK8EaSX2t42iFU4SgbsMi/BIsAyy2NMyB8ua9SziYG7JGwv5z+brl7QJrvniYzkom3JSso=
  organization: beis-nmo-trial
  space: sandbox
  on:
    repo: TransformCore/beis-par-beta
